**Концепция и план развития информационного сервиса**

#HEAD OFFICE
##REST API сервис
####Backup

“Cофтинформ”

Draft 

Автор : Савченко Артур


**Оглавление**

	1.  Предназначение архивации
	2.  Задачи решаемые архивацией
	3.  Описание общей структуры сервиса
	4.  Взаимодействие с другими системами
	5.  Масштабируемость
	6.  Особенности эксплуатации
	7.  Технические аспекты 
	8.  Риски
	9.  Планы и перспективы
	10. Вопросы и пожелания



#Введение
**Архивация** - Важная системная функция которая позволит сохранить данные в критических ситуациях. Суть вопроса заключается в архивировании критической информации и сбережения ее в отдельном сервере. 


**./backup.sh**


    #!/bin/bash

    ## Clear screen
    clear   
    
    ## backup
    ## Файл db.tar будет создан в директории из которой стартовал файл батник
    ## BACKUP - архивируемая директория
    tar cvf db.tar BACKUP

    ## Copy to FTP
    curl -O -T db.tar  ftp://artur_savchenko:12345678password@10.0.10.10/backup_savchenko/DB/

    ## Delete file form disk
    ## Удаление файла после его передачи на фтп сервер 
    rm db.tar  




Пример с директориями :   
####tar -c -z --recursion -p --file=backup.tar directory1 directory2 directory3

**Пример**   
http://stackoverflow.com/questions/984204/shell-command-to-tar-directory-excluding-certain-files-folders

**Пример использования curl**  
http://www.thegeekstuff.com/2012/04/curl-examples/





----------



#[Пример на статьи](http://habrahabr.ru/company/nqhost/blog/117771/)
**Простой способ резервного копирования Linux-сервера с выгрузкой файлов по FTP**

Простой способ резервного копирования Linux-сервера с выгрузкой файлов по FTP

Блог компании NQhost

О важности регулярного резервного копирования уже сказано очень много слов. В этой статье мы предлагаем вниманию читателей примеры простых скриптов для бэкапа файлов и баз данных MySQL с последующей выгрузкой архивов на удаленный FTP-сервер. 
Несмотря на то что мы в NQhost предлагаем решения по сохранению snapshot'ов VPS-контейнеров, процесс бэкапа собственными силами — безусловно важнейшая вещь.


**Хозяйство**  
Виртуальный или физический сервер с установленной Linux-ОС, веб-сервером и базами данных MySQL.
Файлы веб-сервера располагаются в директориях

    /home/site1   
    /home/site2   
    /home/site3   

**Задача**   
Создание скрипта для резервного копирования файлов и баз данных с сохранением на удаленном FTP-сервере и запуск его каждый день.

**Решение**   
Для простоты примера работать мы будем из-под root`а, директория для хранения бэкапов файлов — /root/backup/server, а для дампов MySQL — /root/backup/mysql

**Backup файлов**   
Здесь приводится пример скрипта для бэкапа файлов, для наглядности пояснения даны в квадратных скобках на русском языке. 

	#!/bin/sh
	### System Setup ###
	BACKUP=/root/backup/server
	
	### FTP ###
	FTPD="/"
	FTPU="username" [имя пользавателя (логин) удаленного ftp-cервера]
	FTPP="megapassword" [пароль доступа к удаленному ftp-серверу]
	FTPS="my_remote_backup.ru" [собственно, адрес ftp-сервера или его IP]
	
	### Binaries ###
	TAR="$(which tar)"
	GZIP="$(which gzip)"
	FTP="$(which ftp)"
	
	## Today + hour in 24h format ###
	NOW=$(date +%Y%m%d) [задаем текущую дату и время, чтобы итоговый файл выглядел в виде server-YYYYMMDD.tar.gz]
	
	### Create tmp dir ###
	
	mkdir $BACKUP/$NOW
	$TAR -cf $BACKUP/$NOW/etc.tar /etc [c целью сохранения настроек для простоты копируем весь /etc ]
	$TAR -cf $BACKUP/$NOW/site1.tar /home/site1/
	$TAR -cf $BACKUP/$NOW/site2.tar /home/site2/
	$TAR -cf $BACKUP/$NOW/site2.tar /home/site3/
	
	ARCHIVE=$BACKUP/server-$NOW.tar.gz
	ARCHIVED=$BACKUP/$NOW
	
	$TAR -zcvf $ARCHIVE $ARCHIVED
	
	### ftp ###
	cd $BACKUP
	DUMPFILE=server-$NOW.tar.gz
	$FTP -n $FTPS <<END_SCRIPT
	quote USER $FTPU
	quote PASS $FTPP
	cd $FTPD
	mput $DUMPFILE
	quit
	END_SCRIPT
	
	### clear ###
	
	rm -rf $ARCHIVED
	

Результатом работы данного скрипта будет созданный файл в директории /root/backup/server вида server-ГГГГММДД.tar.gz содержащий в себе tar-архивы директорий /etc, /home/site1, /home/site2 и /home/site3
Этот же файл будет загружен на FTP-сервер, который мы указали в начале скрипта.

**Backup баз MySQL**   
Этим скриптом мы выгружаем базы данных MySQL (делаем т.н. «дампы). Каждая база выгружается в отдельный файл.

	#!/bin/sh
	# System + MySQL backup script
	### System Setup ###
	BACKUP=/root/backup/mysql
	
	### Mysql ### [параметры доступа к нашим базам MySQL]
	MUSER="root"
	MPASS="megapassword"
	MHOST="localhost"
	
	### FTP ###
	FTPD="/"
	FTPU="username" [имя пользавателя (логин) удаленного ftp-cервера]
	FTPP="megapassword" [пароль доступа к удаленному ftp-серверу]
	FTPS="my_remote_backup.ru" [собственно, адрес ftp-сервера или его IP]
	
	### Binaries ###
	TAR="$(which tar)"
	GZIP="$(which gzip)"
	FTP="$(which ftp)"
	MYSQL="$(which mysql)"
	MYSQLDUMP="$(which mysqldump)"
	
	## Today + hour in 24h format ###
	NOW=$(date +%Y%m%d)
	
	### Create temp dir ###
	
	mkdir $BACKUP/$NOW
	
	### name Mysql ###
	DBS="$($MYSQL -u $MUSER -h $MHOST -p$MPASS -Bse 'show databases')"
	for db in $DBS
	do
	
	### ###
	mkdir $BACKUP/$NOW/$db
	FILE=$BACKUP/$NOW/$db/$db.sql.gz
	echo $i; $MYSQLDUMP --add-drop-table --allow-keywords -q -c -u $MUSER -h $MHOST -p$MPASS $db $i | $GZIP -9 > $FILE
	done
	
	ARCHIVE=$BACKUP/mysql-$NOW.tar.gz
	ARCHIVED=$BACKUP/$NOW
	
	$TAR -zcvf $ARCHIVE $ARCHIVED
	
	### ftp ###
	cd $BACKUP
	DUMPFILE=mysql-$NOW.tar.gz
	$FTP -n $FTPS <<END_SCRIPT
	quote USER $FTPU
	quote PASS $FTPP
	cd $FTPD
	mput $DUMPFILE
	quit
	END_SCRIPT
	
	### clear ###
	
	rm -rf $ARCHIVED


Результат работы скрипта — файл в директории /root/backup/server вида mysql-ГГГГММДД.tar.gz содержащий в себе tar-архивы c дампами всех баз данных и его выгрузка на FTP-сервер.

##Автоматизация
Сохраняем данные скрипты в директорию /etc/cron.daily, предварительно проверив в файле /etc/crontab, что именно из этой директории запускаются скрипты каждый день.

##Заключение

Конечно, в каждом конкретном случае скрипты могут меняться и приведенные примеры лишь один из многочисленных вариантов организации резервного копирования. 
Надеемся, что после прочтения этой статьи вы задумаетесь над собственным решением бэкапа, если по каким-то причинам еще не организовали этот важнейший процесс.


##Пример
	#!/bin/bash
	
	cd /home/Backup
	# Бэкап всего что нужно
	tar -cvvzf /home/Backup/back-`date '+%m_%d_%Y'`.tar.bz2 \
	/var/www/ \
	/var/lib/mysql/ \
	/etc/ \
	/var/log/ \
	/root/ \
	--exclude=/home/Backup > ./last.log
	
	# Стираем файлы бэкапа старше 30 дней
	find . -mtime +30 -exec rm '{}' \;
	# Стираем старые логи
	find /var/log/ -type f -name *\.gz -exec rm '{}' \;


А с директорией **/home/Backup** можно делать что угодно, например с Dropbox ее синхронизировать. У меня сервер не большой, суточный бэкап ~300Мб, а за месяц около 10гигов.
 
Запуск по крону каждую ночь, понятно.


##TAR  
Пример

    tar czvf VPSbackup.tar.gz -N"$LAST" --exclude-from=/VPSbackups/tar.excludelist.txt /etc/ /root/exportdb/ /home/username/ > /root/VPSbackups/backup.log 2>&1   

    ##где tar.excludelist.txt - список исключений;  
    ##а LAST - файл с датой в формате date +'%F %R:%S'  
    
    LAST=`cat /root/VPSbackups/lasttimebackup.log` 



## TAR Команда 

Как создать архив .tar.gz
Сама команда tar ничего не компрессирует а всего лишь «сливает» файлы и/или директории в один общий файл. Последующая компрессия выполняется посредством архиватора gzip.

Ниже приведены основные примеры использования команды tar:

    tar -cvf file.tar /full/path — создать .tar
    tar -czvf file.tar.gz /full/path — создать .tar.gz (архив)

Синтаксис для работы с командой tar:

**tar [-ключи] [название архива] [путь, что запаковать]**

Значения ключей:

	с = «create» : создать файл архива   
	v = «verbose» : выводить информацию в процессе выполнения   
	f = «file» : использовать имя файла архива указаное после ключей. Если не указать ключ f то команда будет использовать настройки     по умолчанию либо выведет результат прямо в консоль   
	z = «gzip» : запаковать файл при помощи gzip   
 

**Как открыть (распаковать) .tar**   
Чтобы распаковать запаковыный .tar.gz:

    tar -xvf file.tar.gz

Синтаксис:

**tar [-ключи] [название архива]**

Значения ключей:

		x = «eXtract» : извлечь файлы
		v = «verbose» : выводить информацию в процессе выполнения
		f = «file» : использовать имя файла архива для распаковки указаное после ключей
  


----------

#Примеры


**Создание архивов: программа tar**

Утилита tar предназначена для создания архивов файлов и каталогов. С помощью этой программы можно архивировать файлы, обновлять их в архиве и вводить в этот архив новые файлы. Можно архивировать и целые каталоги со всеми их файлами и подкаталогами. При необходимости все эти файлы и подкаталоги можно восстановить из архива. Программа tar предназначалась для создания архивов на лентах, отсюда и название tar (tape archive, т.е. "архив на ленте"). Архив можно создавать на любом устройстве, например на дискете или в архивном файле на диске. Программа tar - идеальное средство для создания резервных копий файлов или объединения нескольких файлов в один с целью передачи его по сети.

В операционной системе Linux программу tar часто используют для создания архивов на устройствах и в файлах. Ей можно дать указание архивировать файлы на определенном устройстве или в определенном файле, для чего служит опция f с именем устройства или файла. Синтаксис команды tar с опцией f очевиден из нижеследующего примера. Имя устройства или файла часто называют именем архива. При создании файла для tar-архива к имени этого файла обычно добавляется расширение .tar Это условное обозначение; оно не обязательно. В команде можно указать сколько угодно имен файлов. Если указано имя каталога, то в архив включаются и все подкаталоги этого каталога.

**$ tar опцииf имя_архива.tar имена_файлов_и_каталогов**  
Для создания архива служит опция с. В сочетании с опцией f опция с приводит к созданию архива в файле или на устройстве. Эта опция ставится непосредственно перед опцией f. Обратите внимание, что дефиса перед опцией нет. В следующем примере каталог mydir и все его подкаталоги сохраняются в файле myarch.tar.

**$ tar cf myarch.tar mydir**   
Потом пользователь может извлекать каталоги из архива, применяя команду tar с опцией х. Опция xf позволяет извлекать файлы из архивного файла или устройства. При извлечении формируются и все подкаталоги. В следующем примере посредством опции xf команде tar дается указание извлечь все файлы и подкаталоги из файла myarch.tar.

**$ tar xf myarch.tar**   
Для добавления файлов в существующий архив служит опция r. В приведенном ниже примере пользователь добавляет файлы из каталога letters в архив myarch.tar.

**$ tar rf myarch.tar letters**  
Если нужно изменить какой-либо файл в архивированных ранее каталогах, можно с помощью опции u дать команде указание обновить архив, заменив некоторые файлы их новыми версиями. Программа tar сравнивает время последнего изменения каждого архивированного файла и соответствующего файла в каталоге и копирует в архив все файлы с более поздней датой модификации. В архив будут добавлены и все вновь созданные в этих каталогах файлы. В следующем примере пользователь обновляет файл myarch.tar, вводя в него все измененные и вновь созданные в каталоге mydir файлы.

**$ tar uf myarch.tar mydir**   
Если вы хотите посмотреть, какие файлы хранятся в архиве, дайте команду tar с опцией t. В следующем примере показано, как с помощью этой команды можно вызвать список всех файлов, хранящихся в архиве myarch.tar.

**$ tar tf myarch.tar**   
Для создания резервных копий файлов на определенном устройстве укажите имя этого устройства в качестве имени архива. В следующем примере пользователь создает архив на дискете в устройстве /dev/fd0 и копирует в него все файлы из каталога mydir.

**$ tar cf /dev/tdO mydir**   
Для того чтобы извлечь архивированные таким образом файлы, используйте опцию xf.

**$ tar xf /dtv/fd0**   
Если архивируемые файлы занимают больше места, чем имеется на носителе, например на дискете, создайте tar-архив, состоящий из нескольких томов (дискет или лент).

Посредством опции M команде tar дается указание выводить сообщение о том, что текущий носитель заполнен. При архивировании файлов на дискете с использованием опции M в случае заполнения дискеты программа tar предложит вам вставить новую дискету. Таким образом вы сможете записать свой архив на нескольких дискетах.

**$ tar cMf /dev/fd0 mydir**   
Чтобы распаковать архив, записанный на нескольких дискетах, вставьте первую дискету в дисковод и введите команду tar с опциями х и М, как показано ниже. Программа подскажет вам, когда надо вставить следующую дискету.

**$ tar xMf /dev/fd0**   
При использовании команды tar операция сжатия архивных файлов не выполняется. Если вы хотите сжать файлы, дайте tar указание вызвать утилиту gzip. Если команда tar применяется с опцией z, то сначала программа gzip выполняет сжатие, а затем tar архивирует файлы. Та же опция z обеспечит вызов gzip для распаковки файлов при извлечении их из архива.

**$ tar czf myarch.tar mydir**   
Помните, что между сжатием отдельных файлов с последующим архивированием и сжатием всего архива есть разница. Во многих случаях архив создается, чтобы переслать по сети несколько файлов в виде одного tar-файла. Для сокращения времени передачи размер этого архива должен быть по возможности небольшим. Чтобы добиться этого, можно с помощью утилиты gzip сжать архивный tar-файл, уменьшив его размер, а затем переслать сжатую версию. Получатель распакует его и восстановит файл. В результате применения утилиты gzip к tar -файлам часто получаются файлы с расши-рением .tar.gz. Расширение .gz добавляется к сжатому gzip-файлу. В следующем примере создается сжатая версия файла myarch.tar под тем же именем, но с расширением .gz.

**$ gzip myarch.tar**  
**$ la**  
**myarch.tar.gz**     

Если вы хотите создать архив на некотором устройстве, например на ленте или в файле, нужно дать команду tar с опцией f и именем устройства или  файла. Такой вариант эффективен при создании резервных копий файлов. Имя устройства по умолчанию хранится в файле /etc/default/tar. Синтаксис команды tar, подразумевающей использование устройства, заданного по умрлчанию (накопителя на магнитной ленте), приведен в показанном ниже примере. Опция f и имя устройства не задаются. Если указано имя каталога, то в архив включаются все его подкаталоги.

**$ tar опция имена_каталогов_и_файлов**   

В представленном ниже примере каталог mydir со всеми подкаталогами сохраняется на ленте как на носителе по умолчанию.
**$ tar с mydir**   

А в этом примере каталог mydir со всеми файлами и подкаталогами извлекается из устройства, принятого по умолчанию, и помещается в рабочий каталог пользователя.
$ tar x mydir